name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  OPENSHIFT_SERVER: ${{ secrets.OPENSHIFT_SERVER }}
  NAMESPACE: ${{ secrets.NAMESPACE }}
  APP_NAME: ${{ vars.APP_NAME }}
  PORT: ${{ vars.PORT }}
  SPRING_PROFILES_ACTIVE: ${{ vars.SPRING_PROFILES_ACTIVE }}

jobs:
  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis on SonarCloud

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build with Maven
        run: mvn -B verify -DskipTests

      - name: SonarCloud Scan
        uses: sonarsource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONARCLOUD_TOKEN }}
        with:
          args: >
            -Dsonar.organization=${{ vars.SONARCLOUD_ORGANIZATION }}
            -Dsonar.projectKey=${{ vars.SONARCLOUD_PROJECT_KEY }}
            -Dsonar.java.binaries=target/classes
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml


  deploy:
    needs: sonarcloud
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build with Maven
        run: mvn -B clean package -DskipTests

      - name: Install OpenShift CLI
        uses: redhat-actions/openshift-tools-installer@v1
        with:
          oc: '4.12.0'
          skip_cache: true

      - name: Login to OpenShift
        run: |
          oc login --token=${{ secrets.OPENSHIFT_TOKEN }} --server=${{ secrets.OPENSHIFT_SERVER }}
          oc project ${{ secrets.NAMESPACE }}

      - name: Deploy Application
        run: |
          if ! oc get deployment ${{ env.APP_NAME }} &> /dev/null; then
            oc new-app . --name=${{ env.APP_NAME }} \
              --strategy=docker \
              -e SPRING_PROFILES_ACTIVE=${{ env.SPRING_PROFILES_ACTIVE }} \
              -e SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }} \
              -e SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }} \
              -e SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}
          
            oc expose svc/${{ env.APP_NAME }}
          else
            echo "Updating existing application..."
            oc start-build ${{ env.APP_NAME }} --from-dir=. --follow
          fi
          
          oc set probe deployment/${{ env.APP_NAME }} \
            --liveness \
            --get-url=http://:${{ env.PORT }}/actuator/health \
            --initial-delay-seconds=60 \
            --timeout-seconds=5
          
          oc set probe deployment/${{ env.APP_NAME }} \
            --readiness \
            --get-url=http://:${{ env.PORT }}/actuator/health \
            --initial-delay-seconds=30 \
            --timeout-seconds=5
          
          oc rollout status deployment/${{ env.APP_NAME }}
          oc get pods
          oc describe deployment/${{ env.APP_NAME }}